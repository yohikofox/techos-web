name: CI Internal Website Dev

on: [workflow_dispatch]
run-name: Deploy by @${{ github.actor }} at ${{ github.event_name }} ${{ github.sha }}

jobs:
  build-and-publish-docker-image:
    runs-on: ubuntu-latest
    environment: develop
    steps:
      - name: Checkout
        uses: actions/checkout@v4     
      - name: Git Version
        id: version
        uses: codacy/git-version@2.7.1
        with:
          release-branch: main
          dev-branch: develop

      - name: env version
        run: echo "VERSION=${{ steps.version.outputs.version }}" >> $GITHUB_ENV

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v2

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - uses: docker/login-action@v2
        with:
          registry: ${{ secrets.REGISTRY_SERVER }}
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}
      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          push: true
          file: "Dockerfile"
          context: "{{defaultContext}}:."
          tags: ${{secrets.REGISTRY_SERVER}}/techos:${{ steps.version.outputs.version }}

  deploy:
    environment: develop
    runs-on: ubuntu-latest
    needs: ["build-and-publish-docker-image"]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Git Version
        id: version
        with:
          release-branch: main
          dev-branch: develop
        uses: codacy/git-version@2.7.1
      - name: deploy to cluster
        uses: wahyd4/kubectl-helm-action@master
        env:
          KUBE_CONFIG_DATA: ${{ secrets.KUBE_CONFIG }}
        with:
          args: |
            helm upgrade -i backend "./deploy/cms" --set image.tag=${{secrets.REGISTRY_SERVER}}/techos:${{ steps.version.outputs.version }} --set semver=${{ steps.version.outputs.version }} --create-namespace --namespace=${{secrets.NAMESPACE}}

